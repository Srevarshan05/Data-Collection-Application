<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - College Data Collection</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    
    <style>
        /* Mobile Responsive Enhancements */
        @media (max-width: 768px) {
            .stat-card h2 {
                font-size: 1.5rem;
            }
            .stat-card .fa-2x {
                font-size: 1.5rem;
            }
            .card-title {
                font-size: 1rem;
            }
            .table {
                font-size: 0.875rem;
            }
            .filter-section {
                margin-bottom: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .navbar-brand {
                font-size: 0.9rem;
            }
            .btn-sm {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
        }
        
        .filter-active {
            background-color: #0d6efd !important;
            color: white !important;
        }
        
        .download-card {
            transition: transform 0.2s;
        }
        
        .download-card:hover {
            transform: translateY(-2px);
        }
        
        /* Make charts smaller */
        .chart-container {
            max-height: 250px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-user-shield me-2"></i>
                <span class="d-none d-sm-inline">Admin Dashboard</span>
                <span class="d-inline d-sm-none">Admin</span>
            </a>
            <div>
                <a href="/" class="btn btn-light btn-sm rounded-pill me-2">
                    <i class="fas fa-home me-1"></i>
                    <span class="d-none d-sm-inline">Home</span>
                </a>
                <button class="btn btn-outline-light btn-sm rounded-pill" id="refreshBtn">
                    <i class="fas fa-sync-alt me-1"></i>
                    <span class="d-none d-sm-inline">Refresh</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-3 py-md-4">
        <!-- Statistics Cards -->
        <div class="row g-3 g-md-4 mb-3 mb-md-4">
            <!-- Total Students -->
            <div class="col-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100 stat-card">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted mb-1 small">Total</p>
                                <h2 class="mb-0 fw-bold text-primary">{{ total_students }}</h2>
                            </div>
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 p-md-3">
                                <i class="fas fa-users fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Year 1 Students -->
            <div class="col-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100 stat-card">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted mb-1 small">Year 1</p>
                                <h2 class="mb-0 fw-bold text-success">{{ year_wise.get(1, 0) }}</h2>
                            </div>
                            <div class="bg-success bg-opacity-10 rounded-circle p-2 p-md-3">
                                <i class="fas fa-user-graduate fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Year 2 Students -->
            <div class="col-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100 stat-card">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted mb-1 small">Year 2</p>
                                <h2 class="mb-0 fw-bold text-info">{{ year_wise.get(2, 0) }}</h2>
                            </div>
                            <div class="bg-info bg-opacity-10 rounded-circle p-2 p-md-3">
                                <i class="fas fa-user-graduate fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Year 3 Students -->
            <div class="col-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100 stat-card">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted mb-1 small">Year 3</p>
                                <h2 class="mb-0 fw-bold text-warning">{{ year_wise.get(3, 0) }}</h2>
                            </div>
                            <div class="bg-warning bg-opacity-10 rounded-circle p-2 p-md-3">
                                <i class="fas fa-user-graduate fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Download Reports Section with Filters -->
        <div class="row g-3 g-md-4 mb-3 mb-md-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm rounded-3">
                    <div class="card-body p-3">
                        <h5 class="card-title mb-3 mb-md-4">
                            <i class="fas fa-download text-primary me-2"></i>
                            Download Reports
                        </h5>
                        
                        <!-- Filter Buttons -->
                        <div class="mb-3 filter-section">
                            <p class="small text-muted mb-2">Filter by Year:</p>
                            <div class="btn-group flex-wrap" role="group">
                                <button type="button" class="btn btn-outline-primary filter-btn active" data-year="all">
                                    <i class="fas fa-users me-1"></i>All Years
                                </button>
                                <button type="button" class="btn btn-outline-success filter-btn" data-year="1">
                                    <i class="fas fa-user-graduate me-1"></i>Year 1
                                </button>
                                <button type="button" class="btn btn-outline-info filter-btn" data-year="2">
                                    <i class="fas fa-user-graduate me-1"></i>Year 2
                                </button>
                                <button type="button" class="btn btn-outline-warning filter-btn" data-year="3">
                                    <i class="fas fa-user-graduate me-1"></i>Year 3
                                </button>
                            </div>
                        </div>

                        <!-- Download Buttons -->
                        <div class="row g-2 g-md-3 mb-3">
                            <div class="col-12 col-md-6 col-lg-4">
                                <div class="card download-card border border-primary h-100">
                                    <div class="card-body p-3 text-center">
                                        <i class="fas fa-file-excel fa-2x text-primary mb-2"></i>
                                        <h6 class="mb-2">All Students</h6>
                                        <p class="small text-muted mb-3">Excel with photos</p>
                                        <button class="btn btn-primary btn-sm rounded-pill w-100" id="downloadAllBtn">
                                            <i class="fas fa-download me-1"></i>Download Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12 col-md-6 col-lg-4">
                                <div class="card download-card border border-success h-100">
                                    <div class="card-body p-3 text-center">
                                        <i class="fas fa-file-excel fa-2x text-success mb-2"></i>
                                        <h6 class="mb-2">Weekly Report</h6>
                                        <p class="small text-muted mb-3">Last 7 days + photos</p>
                                        <button class="btn btn-success btn-sm rounded-pill w-100" id="downloadWeeklyBtn">
                                            <i class="fas fa-download me-1"></i>Download Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12 col-md-6 col-lg-4">
                                <div class="card download-card border border-info h-100">
                                    <div class="card-body p-3 text-center">
                                        <i class="fas fa-file-excel fa-2x text-info mb-2"></i>
                                        <h6 class="mb-2">Filtered Report</h6>
                                        <p class="small text-muted mb-3" id="filterText">All years + photos</p>
                                        <button class="btn btn-info btn-sm rounded-pill w-100" id="downloadFilteredBtn">
                                            <i class="fas fa-download me-1"></i>Download Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section-wise Download -->
                        <div class="border-top pt-3">
                            <p class="small text-muted mb-2">
                                <i class="fas fa-layer-group me-1"></i>Download by Section (Year + Section):
                            </p>
                            <div class="row g-2" id="sectionDownloadArea">
                                <!-- Year 1 Sections -->
                                <div class="col-12">
                                    <p class="small fw-semibold text-success mb-2">Year 1 Sections:</p>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button class="btn btn-outline-success btn-sm rounded-pill section-download-btn" data-year="1" data-section="A">
                                            <i class="fas fa-download me-1"></i>Y1 - Sec A
                                        </button>
                                        <button class="btn btn-outline-success btn-sm rounded-pill section-download-btn" data-year="1" data-section="B">
                                            <i class="fas fa-download me-1"></i>Y1 - Sec B
                                        </button>
                                        <button class="btn btn-outline-success btn-sm rounded-pill section-download-btn" data-year="1" data-section="C">
                                            <i class="fas fa-download me-1"></i>Y1 - Sec C
                                        </button>
                                        <button class="btn btn-outline-success btn-sm rounded-pill section-download-btn" data-year="1" data-section="D">
                                            <i class="fas fa-download me-1"></i>Y1 - Sec D
                                        </button>
                                        <button class="btn btn-outline-success btn-sm rounded-pill section-download-btn" data-year="1" data-section="E">
                                            <i class="fas fa-download me-1"></i>Y1 - Sec E
                                        </button>
                                    </div>
                                </div>

                                <!-- Year 2 Sections -->
                                <div class="col-12">
                                    <p class="small fw-semibold text-info mb-2">Year 2 Sections:</p>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button class="btn btn-outline-info btn-sm rounded-pill section-download-btn" data-year="2" data-section="A">
                                            <i class="fas fa-download me-1"></i>Y2 - Sec A
                                        </button>
                                        <button class="btn btn-outline-info btn-sm rounded-pill section-download-btn" data-year="2" data-section="B">
                                            <i class="fas fa-download me-1"></i>Y2 - Sec B
                                        </button>
                                        <button class="btn btn-outline-info btn-sm rounded-pill section-download-btn" data-year="2" data-section="C">
                                            <i class="fas fa-download me-1"></i>Y2 - Sec C
                                        </button>
                                        <button class="btn btn-outline-info btn-sm rounded-pill section-download-btn" data-year="2" data-section="D">
                                            <i class="fas fa-download me-1"></i>Y2 - Sec D
                                        </button>
                                        <button class="btn btn-outline-info btn-sm rounded-pill section-download-btn" data-year="2" data-section="E">
                                            <i class="fas fa-download me-1"></i>Y2 - Sec E
                                        </button>
                                    </div>
                                </div>

                                <!-- Year 3 Sections -->
                                <div class="col-12">
                                    <p class="small fw-semibold text-warning mb-2">Year 3 Sections:</p>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button class="btn btn-outline-warning btn-sm rounded-pill section-download-btn" data-year="3" data-section="A">
                                            <i class="fas fa-download me-1"></i>Y3 - Sec A
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm rounded-pill section-download-btn" data-year="3" data-section="B">
                                            <i class="fas fa-download me-1"></i>Y3 - Sec B
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm rounded-pill section-download-btn" data-year="3" data-section="C">
                                            <i class="fas fa-download me-1"></i>Y3 - Sec C
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm rounded-pill section-download-btn" data-year="3" data-section="D">
                                            <i class="fas fa-download me-1"></i>Y3 - Sec D
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-3 g-md-4 mb-3 mb-md-4">
            <!-- Year-wise Distribution Chart -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm rounded-3">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-chart-pie text-primary me-2"></i>
                            Year Distribution
                        </h6>
                        <div class="chart-container">
                            <canvas id="yearChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section-wise Distribution Chart -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm rounded-3">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-chart-bar text-primary me-2"></i>
                            Section Distribution
                        </h6>
                        <div class="chart-container">
                            <canvas id="sectionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Registrations Table with Search -->
        <div class="row g-3 g-md-4 mb-3 mb-md-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm rounded-3">
                    <div class="card-body p-3">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
                            <h5 class="card-title mb-2 mb-md-0">
                                <i class="fas fa-list text-primary me-2"></i>
                                Recent Registrations
                            </h5>
                            <div class="input-group" style="max-width: 300px;">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search...">
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="studentsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th class="d-none d-md-table-cell">Reg. Number</th>
                                        <th>Name</th>
                                        <th class="text-center">Year</th>
                                        <th class="text-center d-none d-sm-table-cell">Section</th>
                                        <th class="d-none d-lg-table-cell">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="text-muted mt-2 mb-0 small">Loading students...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <p class="text-muted small mb-0" id="recordCount">Showing 0 records</p>
                            <button class="btn btn-outline-primary btn-sm rounded-pill" id="loadMoreBtn" style="display: none;">
                                <i class="fas fa-chevron-down me-1"></i>Load More
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Admin Dashboard Script -->
    <script>
        // Global variables
        let allStudents = [];
        let filteredStudents = [];
        let currentFilter = 'all';
        let displayedCount = 10;

        // Year-wise data from backend
        const yearData = {
            1: {{ year_wise.get(1, 0) }},
            2: {{ year_wise.get(2, 0) }},
            3: {{ year_wise.get(3, 0) }}
        };

        // Section-wise data from backend
        const sectionData = {{ section_wise | tojson }};

        // Year-wise Chart
        const yearCtx = document.getElementById('yearChart').getContext('2d');
        new Chart(yearCtx, {
            type: 'doughnut',
            data: {
                labels: ['Year 1', 'Year 2', 'Year 3'],
                datasets: [{
                    data: [yearData[1], yearData[2], yearData[3]],
                    backgroundColor: [
                        'rgba(25, 135, 84, 0.8)',
                        'rgba(13, 202, 240, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: window.innerWidth < 768 ? 10 : 12
                            }
                        }
                    }
                }
            }
        });

        // Section-wise Chart
        const sectionCtx = document.getElementById('sectionChart').getContext('2d');
        const sections = Object.keys(sectionData).sort();
        const sectionCounts = sections.map(s => sectionData[s]);

        new Chart(sectionCtx, {
            type: 'bar',
            data: {
                labels: sections.map(s => `Sec ${s}`),
                datasets: [{
                    label: 'Students',
                    data: sectionCounts,
                    backgroundColor: 'rgba(13, 110, 253, 0.8)',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            font: {
                                size: window.innerWidth < 768 ? 10 : 12
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: window.innerWidth < 768 ? 10 : 12
                            }
                        }
                    }
                }
            }
        });

        // Load students
        async function loadStudents() {
            try {
                const response = await fetch('/api/students');
                const data = await response.json();
                allStudents = data.students;
                filteredStudents = allStudents;
                displayStudents();
            } catch (error) {
                console.error('Error loading students:', error);
                showError();
            }
        }

        // Display students in table
        function displayStudents() {
            const tbody = document.getElementById('studentsTableBody');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const recordCount = document.getElementById('recordCount');
            
            if (filteredStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="mb-0">No students found</p>
                        </td>
                    </tr>
                `;
                loadMoreBtn.style.display = 'none';
                recordCount.textContent = 'Showing 0 records';
                return;
            }
            
            const studentsToShow = filteredStudents.slice(0, displayedCount);
            
            tbody.innerHTML = studentsToShow.map(student => {
                const date = new Date(student.created_at);
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const yearColor = student.year === 1 ? 'success' : student.year === 2 ? 'info' : 'warning';
                
                return `
                    <tr>
                        <td class="d-none d-md-table-cell"><strong class="small">${student.register_number}</strong></td>
                        <td>
                            <div>${student.name}</div>
                            <small class="text-muted d-md-none">${student.register_number}</small>
                        </td>
                        <td class="text-center"><span class="badge bg-${yearColor}">Y${student.year}</span></td>
                        <td class="text-center d-none d-sm-table-cell"><span class="badge bg-secondary">${student.section}</span></td>
                        <td class="d-none d-lg-table-cell small">${formattedDate}</td>
                    </tr>
                `;
            }).join('');
            
            // Update record count
            recordCount.textContent = `Showing ${studentsToShow.length} of ${filteredStudents.length} records`;
            
            // Show/hide load more button
            loadMoreBtn.style.display = filteredStudents.length > displayedCount ? 'block' : 'none';
        }

        // Show error
        function showError() {
            document.getElementById('studentsTableBody').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p class="mb-0">Error loading students</p>
                    </td>
                </tr>
            `;
        }

        // Filter students by year
        function filterByYear(year) {
            currentFilter = year;
            displayedCount = 10;
            
            if (year === 'all') {
                filteredStudents = allStudents;
                document.getElementById('filterText').textContent = 'All years + photos';
            } else {
                filteredStudents = allStudents.filter(s => s.year === parseInt(year));
                document.getElementById('filterText').textContent = `Year ${year} + photos`;
            }
            
            displayStudents();
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm === '') {
                filterByYear(currentFilter);
                return;
            }
            
            filteredStudents = allStudents.filter(student => {
                if (currentFilter !== 'all' && student.year !== parseInt(currentFilter)) {
                    return false;
                }
                
                return student.name.toLowerCase().includes(searchTerm) ||
                       student.register_number.toLowerCase().includes(searchTerm) ||
                       student.section.toLowerCase().includes(searchTerm);
            });
            
            displayedCount = 10;
            displayStudents();
        });

        // Filter button clicks
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                filterByYear(this.dataset.year);
            });
        });

        // Load more button
        document.getElementById('loadMoreBtn').addEventListener('click', () => {
            displayedCount += 10;
            displayStudents();
        });

        // Download all students report
        document.getElementById('downloadAllBtn').addEventListener('click', async () => {
            const btn = document.getElementById('downloadAllBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating Excel...';
            
            window.location.href = '/api/download-report';
            
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download me-1"></i>Download Excel';
            }, 3000);
        });

        // Download weekly report
        document.getElementById('downloadWeeklyBtn').addEventListener('click', async () => {
            const btn = document.getElementById('downloadWeeklyBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating Excel...';
            
            window.location.href = '/api/download-weekly-report';
            
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download me-1"></i>Download Excel';
            }, 3000);
        });

        // Download filtered report
        document.getElementById('downloadFilteredBtn').addEventListener('click', async () => {
            const btn = document.getElementById('downloadFilteredBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating Excel...';
            
            if (currentFilter === 'all') {
                window.location.href = '/api/download-report';
            } else {
                window.location.href = `/api/download-year-report/${currentFilter}`;
            }
            
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download me-1"></i>Download Excel';
            }, 3000);
        });

        // Section-wise download buttons
        document.querySelectorAll('.section-download-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const year = this.dataset.year;
                const section = this.dataset.section;
                
                this.disabled = true;
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
                
                window.location.href = `/api/download-section-report/${year}/${section}`;
                
                setTimeout(() => {
                    this.disabled = false;
                    this.innerHTML = originalHTML;
                }, 3000);
            });
        });

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            location.reload();
        });

        // Load students on page load
        loadStudents();
    </script>
</body>
</html>
