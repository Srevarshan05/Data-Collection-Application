<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - College Data Collection</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-user-shield me-2"></i>
                Admin Dashboard
            </a>
            <div>
                <a href="/" class="btn btn-light btn-sm rounded-pill me-2">
                    <i class="fas fa-home me-1"></i>Home
                </a>
                <button class="btn btn-outline-light btn-sm rounded-pill" id="refreshBtn">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Statistics Cards -->
        <div class="row g-4 mb-4">
            <!-- Total Students -->
            <div class="col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted mb-1 small">Total Students</p>
                                <h2 class="mb-0 fw-bold text-primary">{{ total_students }}</h2>
                            </div>
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-users fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Year 1 Students -->
            <div class="col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted mb-1 small">Year 1 Students</p>
                                <h2 class="mb-0 fw-bold text-success">{{ year_wise.get(1, 0) }}</h2>
                            </div>
                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-user-graduate fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Year 2 Students -->
            <div class="col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted mb-1 small">Year 2 Students</p>
                                <h2 class="mb-0 fw-bold text-info">{{ year_wise.get(2, 0) }}</h2>
                            </div>
                            <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-user-graduate fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Year 3 Students -->
            <div class="col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted mb-1 small">Year 3 Students</p>
                                <h2 class="mb-0 fw-bold text-warning">{{ year_wise.get(3, 0) }}</h2>
                            </div>
                            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-user-graduate fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Registrations Card -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm rounded-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-1">
                                    <i class="fas fa-calendar-week text-primary me-2"></i>
                                    Weekly Registrations
                                </h5>
                                <p class="text-muted small mb-0">Students registered in the last 7 days</p>
                            </div>
                            <div>
                                <h2 class="mb-0 fw-bold text-primary">{{ weekly_count }}</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-4 mb-4">
            <!-- Year-wise Distribution Chart -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-chart-pie text-primary me-2"></i>
                            Year-wise Distribution
                        </h5>
                        <canvas id="yearChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Section-wise Distribution Chart -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-chart-bar text-primary me-2"></i>
                            Section-wise Distribution
                        </h5>
                        <canvas id="sectionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Download Reports Section -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm rounded-3">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-download text-primary me-2"></i>
                            Download Reports
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-grid">
                                    <button class="btn btn-primary btn-lg rounded-pill" id="downloadAllBtn">
                                        <i class="fas fa-file-csv me-2"></i>
                                        Download All Students Report
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-grid">
                                    <button class="btn btn-success btn-lg rounded-pill" id="downloadWeeklyBtn">
                                        <i class="fas fa-calendar-week me-2"></i>
                                        Download Weekly Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Registrations Table -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm rounded-3">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-list text-primary me-2"></i>
                            Recent Registrations
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="studentsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Registration Number</th>
                                        <th>Name</th>
                                        <th>Year</th>
                                        <th>Section</th>
                                        <th>Registration Date</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="text-muted mt-2 mb-0">Loading students...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Admin Dashboard Script -->
    <script>
        // Year-wise data from backend
        const yearData = {
            1: {{ year_wise.get(1, 0) }},
            2: {{ year_wise.get(2, 0) }},
            3: {{ year_wise.get(3, 0) }}
        };

        // Section-wise data from backend
        const sectionData = {{ section_wise | tojson }};

        // Year-wise Chart
        const yearCtx = document.getElementById('yearChart').getContext('2d');
        new Chart(yearCtx, {
            type: 'doughnut',
            data: {
                labels: ['Year 1', 'Year 2', 'Year 3'],
                datasets: [{
                    data: [yearData[1], yearData[2], yearData[3]],
                    backgroundColor: [
                        'rgba(25, 135, 84, 0.8)',
                        'rgba(13, 202, 240, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });

        // Section-wise Chart
        const sectionCtx = document.getElementById('sectionChart').getContext('2d');
        const sections = Object.keys(sectionData).sort();
        const sectionCounts = sections.map(s => sectionData[s]);

        new Chart(sectionCtx, {
            type: 'bar',
            data: {
                labels: sections.map(s => `Section ${s}`),
                datasets: [{
                    label: 'Number of Students',
                    data: sectionCounts,
                    backgroundColor: 'rgba(13, 110, 253, 0.8)',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Load recent students
        async function loadStudents() {
            try {
                const response = await fetch('/api/students');
                const data = await response.json();
                
                const tbody = document.getElementById('studentsTableBody');
                
                if (data.students.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p class="mb-0">No students registered yet</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = data.students.slice(0, 10).map(student => {
                    const date = new Date(student.created_at);
                    const formattedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    return `
                        <tr>
                            <td><strong>${student.register_number}</strong></td>
                            <td>${student.name}</td>
                            <td><span class="badge bg-primary">Year ${student.year}</span></td>
                            <td><span class="badge bg-secondary">Section ${student.section}</span></td>
                            <td>${formattedDate}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('studentsTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p class="mb-0">Error loading students</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Download all students report
        document.getElementById('downloadAllBtn').addEventListener('click', async () => {
            try {
                const btn = document.getElementById('downloadAllBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Downloading...';
                
                window.location.href = '/api/download-report';
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-file-csv me-2"></i>Download All Students Report';
                }, 2000);
            } catch (error) {
                console.error('Error downloading report:', error);
                alert('Error downloading report. Please try again.');
            }
        });

        // Download weekly report
        document.getElementById('downloadWeeklyBtn').addEventListener('click', async () => {
            try {
                const btn = document.getElementById('downloadWeeklyBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Downloading...';
                
                window.location.href = '/api/download-weekly-report';
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-calendar-week me-2"></i>Download Weekly Report';
                }, 2000);
            } catch (error) {
                console.error('Error downloading weekly report:', error);
                alert('Error downloading weekly report. Please try again.');
            }
        });

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            location.reload();
        });

        // Load students on page load
        loadStudents();
    </script>
</body>
</html>
